name: Build and Deploy Wine Quality Model

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    outputs:
      mse: ${{ steps.metrics.outputs.mse }}
      r2: ${{ steps.metrics.outputs.r2 }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Train Model
        run: |
          python train.py

      - name: Capture Metrics
        id: metrics
        run: |
          MSE=$(jq .MSE output/results.json)
          R2=$(jq .R2 output/results.json)
          echo "MSE=$MSE" >> $GITHUB_OUTPUT
          echo "R2=$R2" >> $GITHUB_OUTPUT
          echo "Captured Metrics: MSE=$MSE, R2=$R2"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            output/model.pkl
            output/results.json

  deploy:
    needs: train
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: app/

      - name: Compare Metrics
        id: compare
        env:
          CURRENT_MSE: ${{ needs.train.outputs.mse }}
          BEST_MSE: ${{ vars.BEST_MSE }}
        run: |
          echo "Current MSE: $CURRENT_MSE"
          echo "Best MSE: $BEST_MSE"
          if (( $(echo "$CURRENT_MSE < $BEST_MSE" | bc -l) )); then
            echo "New model is better!"
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "New model is NOT better. Skipping deployment."
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        if: steps.compare.outputs.deploy == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        if: steps.compare.outputs.deploy == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: lab3/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/wine_predict_2022bcs0111:v1,${{ secrets.DOCKER_USERNAME }}/wine_predict_2022bcs0111:latest

      - name: Update GitHub Variables
        if: steps.compare.outputs.deploy == 'true'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
          BEST_MSE: ${{ needs.train.outputs.mse }}
        run: |
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_PAT" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO/actions/variables/BEST_MSE \
            -d "{\"name\":\"BEST_MSE\",\"value\":\"$BEST_MSE\"}"
